<!DOCTYPE html>
<html>

<head>
  <meta charset="UTF-8">
  <link rel="stylesheet" href="popup.css">
</head>

<body>
  <header>
    <div class="logo">
      <span>üìÑ</span> ForgeCV
    </div>
    <div class="controls">
      <button id="profileToggle" class="icon-btn" title="Manage Profile">üë§</button>
      <button id="settingsToggle" class="icon-btn" title="Settings">‚öôÔ∏è</button>
    </div>
  </header>

  <div id="status"></div>

  <!-- Settings UI -->
  <div id="settingsUI" class="hidden">
    <div class="flex-between" style="margin-bottom: 16px;">
      <h3>Settings</h3>
      <button id="backFromSettings" class="secondary-btn icon-btn"
        style="width:auto; padding: 4px 8px; font-size:11px;">‚úï</button>
    </div>

    <div class="settings-card">
      <div class="edit-field">
        <label for="providerSelect">AI Provider</label>
        <select id="providerSelect">
          <option value="gemini">Google Gemini (Recommended)</option>
          <option value="groq">Groq (Llama 3)</option>
        </select>
      </div>

      <div id="geminiKeyData" class="key-section">
        <label for="apiKey">Gemini API Key</label>
        <div style="position:relative;">
          <input type="password" id="apiKey" placeholder="Enter Gemini API Key">
        </div>
        <details class="help-details">
          <summary>How to get a Free Gemini API Key</summary>
          <div style="margin-bottom:8px; font-weight:600; color:var(--success);">‚ú® One-time setup. Using free tier.
          </div>
          <ol>
            <li>Go to <a href="https://aistudio.google.com/app/apikey" target="_blank">Google AI Studio</a>.</li>
            <li>Click the blue <strong>"Get API key"</strong> button.</li>
            <li>Select <strong>"Create API key in new project"</strong>.</li>
            <li>Copy the key that starts with <code>AIza...</code> and paste it above.</li>
          </ol>
          <div class="ask-ai-box">
            <div class="ask-ai-label">üôã Still stuck? Copy & Paste this into ChatGPT/Claude:</div>
            <div class="ask-ai-prompt" onclick="navigator.clipboard.writeText(this.innerText); alert('Copied!')">
              "Explain how to get a free Google Gemini API Key like I'm 5 years old and easily confused by buttons. Walk
              me through every click starting from opening Google."
            </div>
            <div style="text-align:right; font-size:9px; color:var(--primary); margin-top:2px;">(Click to copy)</div>
          </div>
        </details>
      </div>

      <div id="groqKeyData" class="key-section hidden">
        <label for="groqApiKey">Groq API Key</label>
        <input type="password" id="groqApiKey" placeholder="Enter Groq API Key">
        <details class="help-details">
          <summary>How to get a Free Groq Key</summary>
          <div style="margin-bottom:8px; font-weight:600; color:var(--success);">‚ú® One-time setup. Using free tier.
          </div>
          <ol>
            <li>Go to <a href="https://console.groq.com/keys" target="_blank">Groq Console</a>.</li>
            <li><strong>Important:</strong> Sign up using <strong>Google</strong> or <strong>GitHub</strong> (Email
              signup often fails).</li>
            <li>Click <strong>"Create API Key"</strong>.</li>
            <li>Name it "Resume" and copy the key starting with <code>gsk_...</code>.</li>
          </ol>
          <div class="ask-ai-box">
            <div class="ask-ai-label">üôã Still stuck? Copy & Paste this into ChatGPT/Claude:</div>
            <div class="ask-ai-prompt" onclick="navigator.clipboard.writeText(this.innerText); alert('Copied!')">
              "Explain how to get a free Groq API Key like I'm a time traveler from 1995 who just discovered the
              internet. Be super specific about clicking 'Create API Key'."
            </div>
            <div style="text-align:right; font-size:9px; color:var(--primary); margin-top:2px;">(Click to copy)</div>
          </div>
        </details>
      </div>

      <div id="nvidiaKeyData" class="key-section hidden">
        <label for="nvidiaApiKey">NVIDIA API Key</label>
        <input type="password" id="nvidiaApiKey" placeholder="Enter NVIDIA API Key (starts with nvapi-...)">
        <div class="text-sm text-muted" style="margin-top:4px;">
          Get key from <a href="https://build.nvidia.com/meta/llama-4-maverick-17b-128e-instruct" target="_blank">NVIDIA
            (Maverick)</a>. Click "Get API Key".
        </div>
      </div>

      <button id="saveSettingsBtn" class="primary-btn" style="width:100%; margin-top:16px;">Save Settings</button>
      <button id="skipSettingsBtn" class="secondary-btn" style="width:100%; margin-top:8px;">Skip for now</button>
      <div id="settingsStatus"></div>
    </div>
  </div>

  <!-- Profile Management UI -->
  <div id="profileUI" class="hidden">
    <div class="flex-between" style="margin-bottom: 16px;">
      <h3>Manage Profile</h3>
      <button id="backFromProfile" class="secondary-btn icon-btn"
        style="width:auto; padding: 4px 8px; font-size:11px;">‚úï</button>
    </div>

    <div class="card" style="margin-bottom: 12px;">
      <h4 style="margin-bottom: 10px;">üìÇ Profiles</h4>
      <div id="profileList" style="margin-bottom: 10px;"></div>
      <div style="display: flex; gap: 8px;">
        <input type="text" id="newProfileName" placeholder="New profile name..."
          style="flex: 1; font-size: 12px; padding: 8px;">
        <button id="createProfileBtn" class="secondary-btn"
          style="white-space: nowrap; font-size: 12px; padding: 8px 12px;">+ Create</button>
      </div>
    </div>

    <div class="card">
      <h4 style="margin-bottom:12px;">üìÑ Re-upload Base Resume</h4>
      <input type="file" id="reuploadResumeFile" accept=".pdf" style="margin-bottom:10px;">
      <button id="reuploadBtn" class="primary-btn" style="width:100%;">Upload New Resume</button>

      <div class="divider-or"><span>OR PASTE TEXT</span></div>

      <textarea id="reuploadResumeText" placeholder="Paste full resume text..." style="height: 80px;"></textarea>
      <button id="reuploadTextBtn" class="primary-btn" style="width:100%; margin-top:8px;">Process Text</button>
    </div>

    <div class="card">
      <h4 style="margin-bottom:12px;">‚úèÔ∏è Manual Edit</h4>
      <label for="profileSectionSelect" class="text-sm text-muted">Select Section:</label>
      <select id="profileSectionSelect" style="margin-bottom:12px;">
        <option value="contact">Contact Info</option>
        <option value="education">Education</option>
        <option value="experience">Experience</option>
        <option value="projects">Projects</option>
        <option value="skills">Skills</option>
        <option value="leadership">Leadership</option>
        <option value="research">Research & Publications</option>
        <option value="certifications">Certifications</option>
        <option value="awards">Awards & Honors</option>
        <option value="volunteering">Volunteering</option>
        <option value="languages">Languages</option>
      </select>

      <div id="profileFormContainer" style="max-height: 400px; overflow-y: auto;"></div>

      <div class="flex-between" style="gap:10px; margin-top:16px;">
        <button id="saveProfileBtn" class="primary-btn" style="flex:1;">Save Changes</button>
        <button id="cancelProfileEditBtn" class="secondary-btn" style="flex:1;">Cancel</button>
      </div>
    </div>
    <div id="profileStatus"></div>
  </div>

  <!-- Setup UI -->
  <div id="setupUI" class="hidden">
    <div class="upload-zone">
      <h2 style="font-size:18px; margin-bottom:8px;">Welcome to ForgeCV</h2>
      <p class="text-muted" style="margin-bottom:20px;">Upload your resume to get started.</p>

      <div style="display:flex; justify-content:space-between; align-items:center;">
        <h3 style="margin:0;">Setup</h3>
        <button id="backFromSetup" class="secondary-btn" style="font-size:11px; padding:4px 8px;">Back</button>
      </div>

      <input type="file" id="resumeFile" accept=".pdf" style="margin: 16px 0;">
      <button id="uploadBtn" class="primary-btn" style="width:100%;">Upload Resume</button>
      <div id="uploadStatus"></div>

      <div class="divider-or"><span>OR PASTE TEXT</span></div>

      <textarea id="resumeTextInit" placeholder="Paste resume text..." style="height: 100px;"></textarea>
      <button id="processTextInitBtn" class="primary-btn" style="width:100%; margin-top:8px;">Process Text</button>
      <div id="textStatus" style="margin-top:8px;"></div>
    </div>
  </div>

  <!-- Main UI -->
  <div id="mainUI" class="hidden">
    <div class="profile-pill">
      <span>Using:</span> <strong id="profileName">Loading...</strong>
      <span id="activeProfileLabel" style="font-size:10px; opacity:0.7; margin-left:4px;"></span>
    </div>

    <!-- Tailoring Strategy -->
    <div class="card">
      <label class="text-sm font-bold text-muted" style="display:block; margin-bottom:8px;">TAILORING BASIS</label>
      <input type="range" id="tailoringSlider" min="0" max="2" value="1" step="1">
      <div class="strategy-labels">
        <span>Profile Focus</span>
        <span>Balanced</span>
        <span>JD Focus</span>
      </div>
      <div id="strategyDescription" class="text-sm text-muted" style="margin-top:12px; font-style:italic;">
        Balanced approach - integrates JD keywords...
      </div>
    </div>

    <div style="display:flex; flex-direction:column; gap:8px;">
      <button id="generateBtn" class="primary-btn" style="padding:14px;">‚ö° Process Page & Generate Resume</button>
      <button id="generateBaseBtn" class="secondary-btn">Generate Base Resume (No AI)</button>
    </div>

    <!-- Actions (Post-Generation) -->
    <div id="actions" class="hidden">
      <div class="actions-grid">
        <button id="previewBtn">üëÅ Preview PDF</button>
        <button id="downloadBtn">‚¨á Download PDF</button>
        <button id="editBtn">‚úè Manual Editor</button>
        <button id="formatBtn" class="secondary-btn">üé® Format</button>
        <button id="copyContentBtn">üìã Copy Content</button>
        <button id="historyBtn" class="secondary-btn">üïê History</button>
        <button id="analyzeBtn" class="secondary-btn">üìä Analyze ATS Score</button>
      </div>

      <!-- Drag & Drop Resume Card -->
      <div id="dragCard" class="hidden" style="margin-top: 12px;">
        <div id="dragHandle" draggable="true" style="
                display: flex;
                align-items: center;
                justify-content: center;
                gap: 10px;
                padding: 14px 16px;
                background: linear-gradient(135deg, #f0f4ff 0%, #e8ecff 100%);
                border: 2px dashed #818cf8;
                border-radius: 10px;
                cursor: grab;
                transition: all 0.2s;
                user-select: none;
            ">
          <span style="font-size: 20px;">üìÑ</span>
          <div>
            <div id="dragFileName" style="font-weight: 600; font-size: 12px; color: #4338ca;">Drag resume to upload
            </div>
            <div style="font-size: 10px; color: #6366f1;">Drop onto any file upload field on the page</div>
          </div>
          <span style="font-size: 16px; color: #a5b4fc;">‚áó</span>
        </div>
      </div>

      <!-- Generation Progress -->
      <div id="generationProgress" class="hidden card" style="margin-top: 16px;">
        <div style="display: flex; align-items: center; gap: 10px; margin-bottom: 10px;">
          <div id="progressSpinner" class="spinner"></div>
          <span id="progressStepText" style="font-weight: 500; font-size: 13px;">Preparing...</span>
        </div>
        <div id="progressBar" style="height: 4px; background: #e5e7eb; border-radius: 2px; overflow: hidden;">
          <div id="progressFill"
            style="height: 100%; width: 0%; background: linear-gradient(90deg, #667eea, #764ba2); transition: width 0.5s ease;">
          </div>
        </div>
        <div id="progressDetail" class="text-sm text-muted" style="margin-top: 6px; font-size: 11px;"></div>
      </div>
    </div>

    <!-- Copy UI -->
    <div id="copyUI" class="hidden card">
      <div class="flex-between">
        <h3>Copy Content</h3>
        <button id="closeCopyBtn" class="secondary-btn icon-btn">‚úï</button>
      </div>
      <div id="copyList"></div>
    </div>

    <!-- Format Settings UI -->
    <div id="formatUI" class="hidden card">
      <div class="flex-between" style="margin-bottom: 12px;">
        <h3>Resume Format</h3>
        <button id="closeFormatBtn" class="secondary-btn icon-btn">‚úï</button>
      </div>

      <div class="edit-field" style="margin-bottom: 12px;">
        <label class="text-sm text-muted">FONT FAMILY</label>
        <div style="display: flex; gap: 6px;">
          <button class="format-option" data-setting="font" data-value="times"
            style="flex:1; font-family: 'Times New Roman', serif; font-size: 12px; padding: 8px;">Times</button>
          <button class="format-option" data-setting="font" data-value="helvetica"
            style="flex:1; font-family: Helvetica, Arial, sans-serif; font-size: 12px; padding: 8px;">Helvetica</button>
          <button class="format-option" data-setting="font" data-value="courier"
            style="flex:1; font-family: 'Courier New', monospace; font-size: 12px; padding: 8px;">Courier</button>
        </div>
      </div>

      <div class="edit-field" style="margin-bottom: 12px;">
        <label class="text-sm text-muted">DENSITY</label>
        <div style="display: flex; gap: 6px;">
          <button class="format-option" data-setting="density" data-value="compact"
            style="flex:1; font-size: 11px; padding: 8px;">Compact</button>
          <button class="format-option" data-setting="density" data-value="normal"
            style="flex:1; font-size: 11px; padding: 8px;">Normal</button>
          <button class="format-option" data-setting="density" data-value="spacious"
            style="flex:1; font-size: 11px; padding: 8px;">Spacious</button>
        </div>
      </div>

      <div class="edit-field" style="margin-bottom: 12px;">
        <label class="text-sm text-muted">MARGINS</label>
        <div style="display: flex; gap: 6px;">
          <button class="format-option" data-setting="margins" data-value="narrow"
            style="flex:1; font-size: 11px; padding: 8px;">Narrow</button>
          <button class="format-option" data-setting="margins" data-value="normal"
            style="flex:1; font-size: 11px; padding: 8px;">Normal</button>
          <button class="format-option" data-setting="margins" data-value="wide"
            style="flex:1; font-size: 11px; padding: 8px;">Wide</button>
        </div>
      </div>

      <div class="edit-field" style="margin-bottom: 12px;">
        <label class="text-sm text-muted">NAME SIZE</label>
        <div style="display: flex; align-items: center; gap: 10px;">
          <input type="range" id="nameSizeSlider" min="16" max="28" value="21" step="1" style="flex: 1;">
          <span id="nameSizeValue" style="font-size: 12px; min-width: 30px; text-align: center;">21pt</span>
        </div>
      </div>

      <div class="edit-field" style="margin-bottom: 12px;">
        <label class="text-sm text-muted">BODY TEXT SIZE</label>
        <div style="display: flex; align-items: center; gap: 10px;">
          <input type="range" id="bodySizeSlider" min="9" max="14" value="10" step="0.5" style="flex: 1;">
          <span id="bodySizeValue" style="font-size: 12px; min-width: 30px; text-align: center;">10pt</span>
        </div>
      </div>

      <div class="edit-field" style="margin-bottom: 12px;">
        <label class="text-sm text-muted">SECTION HEADER SIZE</label>
        <div style="display: flex; align-items: center; gap: 10px;">
          <input type="range" id="headerSizeSlider" min="10" max="24" value="12" step="1" style="flex: 1;">
          <span id="headerSizeValue" style="font-size: 12px; min-width: 30px; text-align: center;">12pt</span>
        </div>
      </div>

      <div class="edit-field" style="margin-bottom: 12px;">
        <label class="text-sm text-muted">SUB-HEADING SIZE</label>
        <div style="display: flex; align-items: center; gap: 10px;">
          <input type="range" id="subheaderSizeSlider" min="10" max="18" value="11" step="0.5" style="flex: 1;">
          <span id="subheaderSizeValue" style="font-size: 12px; min-width: 30px; text-align: center;">11pt</span>
        </div>
      </div>

      <div class="edit-field" style="margin-bottom: 12px;">
        <label class="text-sm text-muted">SECTION HEADERS</label>
        <select id="headerStyleSelect" style="font-size: 12px;">
          <option value="uppercase_line">UPPERCASE + Line (Default)</option>
          <option value="uppercase_noline">UPPERCASE Only</option>
          <option value="bold_line">Bold Title Case + Line</option>
          <option value="bold_noline">Bold Title Case Only</option>
        </select>
      </div>

      <div class="edit-field" style="margin-bottom: 12px;">
        <label class="text-sm text-muted">BULLET STYLE</label>
        <div style="display: flex; gap: 6px;">
          <button class="format-option" data-setting="bulletChar" data-value="‚Ä¢"
            style="flex:1; font-size: 14px; padding: 8px;">‚Ä¢</button>
          <button class="format-option" data-setting="bulletChar" data-value="‚Äì"
            style="flex:1; font-size: 14px; padding: 8px;">‚Äì</button>
        </div>
      </div>

      <div class="edit-field" style="margin-bottom: 12px;">
        <label class="text-sm text-muted">PAGE SIZE</label>
        <div style="display: flex; gap: 6px;">
          <button class="format-option" data-setting="pageSize" data-value="letter"
            style="flex:1; font-size: 11px; padding: 8px;">US Letter</button>
          <button class="format-option" data-setting="pageSize" data-value="a4"
            style="flex:1; font-size: 11px; padding: 8px;">A4</button>
        </div>
      </div>

      <div style="display: flex; align-items: center; gap: 8px; margin-bottom: 12px;">
        <input type="checkbox" id="showLinksCheck" checked style="width: auto;">
        <label for="showLinksCheck" class="text-sm" style="margin: 0;">Show clickable links in contact line</label>
      </div>

      <div style="display: flex; gap: 8px; margin-top: 16px;">
        <button id="previewFormatBtn" class="primary-btn" style="flex: 1; font-size: 12px;">üëÅ Preview</button>
        <button id="resetFormatBtn" class="secondary-btn" style="flex: 1; font-size: 12px;">‚Ü© Reset Defaults</button>
      </div>
    </div>

    <!-- History UI -->
    <div id="historyUI" class="hidden card">
      <div class="flex-between" style="margin-bottom: 12px;">
        <h3>Resume History</h3>
        <button id="closeHistoryBtn" class="secondary-btn icon-btn">‚úï</button>
      </div>
      <div id="historyList"></div>
    </div>

    <!-- Editor UI -->
    <div id="editorUI" class="hidden">
      <div class="flex-between" style="margin-bottom:12px;">
        <div style="display:flex; align-items:center; gap:8px;">
          <h3>Edit Resume Content</h3>
          <button id="popoutEditorBtn" class="icon-btn" title="Open in full window"
            style="font-size: 12px; height:24px; padding:0 6px;">‚ÜóÔ∏è</button>
        </div>
        <button id="reorderBtn"
          style="background:none; border:none; color:var(--primary); font-size:12px; cursor:pointer;">‚áÖ Reorder
          Sections</button>
      </div>

      <!-- Reorder Box -->
      <div id="reorderUI" class="hidden card" style="background:#f1f5f9;">
        <h4 style="font-size:13px; margin-bottom:10px;">Drag to Reorder</h4>
        <ul id="sortableSections" style="list-style:none; padding:0; margin:0 0 10px 0;"></ul>
        <div class="flex-between" style="gap:8px;">
          <button id="saveOrderBtn" class="primary-btn" style="flex:1;">Save</button>
          <button id="cancelOrderBtn" class="secondary-btn" style="flex:1;">Cancel</button>
        </div>
      </div>

      <div class="edit-field">
        <select id="sectionSelect">
          <optgroup label="Sections">
            <option value="summary">Summary</option>
            <option value="education">Education</option>
            <option value="skills">Skills</option>
            <option value="experience">Experience</option>
            <option value="projects">Projects</option>
            <option value="leadership">Leadership</option>
            <option value="research">Research & Publications</option>
            <option value="certifications">Certifications</option>
            <option value="awards">Awards & Honors</option>
            <option value="volunteering">Volunteering</option>
            <option value="languages">Languages</option>
            <option value="contact">Contact Info (Location/Links)</option>
          </optgroup>
        </select>
      </div>

      <div id="formContainer" style="max-height: 400px; overflow-y: auto; padding-bottom: 20px;"></div>

      <div class="editor-footer">
        <button id="saveManualBtn" style="background:var(--primary); color:white;">Save Changes</button>
        <button id="saveRegenBtn" style="background:var(--success); color:white;">Save & Regenerate</button>
        <button id="editorPreviewBtn" class="secondary-btn">üëÅ Preview</button>
        <button id="cancelEditBtn" class="secondary-btn">Cancel</button>
      </div>
    </div>

    <!-- Analysis Results -->
    <div id="analysisResults" class="hidden card" style="margin-top:16px;">
      <h3 style="border-bottom:1px solid #e2e8f0; padding-bottom:8px;">ATS Analysis</h3>
      <div style="display: flex; align-items: center; gap:16px; margin-bottom: 12px;">
        <div id="atsScore">--</div>
        <div>
          <div style="font-weight:700; font-size:14px;">Match Score</div>
          <div class="text-sm text-muted">Analysis based on basic keywords</div>
        </div>
      </div>
      <div id="analysisDetails"></div>
    </div>

    <!-- Question Helper -->
    <div style="margin-top: 20px;">
      <details class="card" style="padding:0; overflow:hidden;">
        <summary
          style="padding:12px; font-weight:600; cursor:pointer; list-style:none; display:flex; justify-content:space-between; align-items:center;">
          üí° Application Question Helper <span style="font-size:10px;">‚ñº</span>
        </summary>
        <div style="padding:16px; border-top:1px solid #f1f5f9;">
          <textarea id="questionInput" placeholder="Paste application question..."
            style="height:60px; margin-bottom:8px;"></textarea>
          <div style="display:flex; justify-content:flex-end;">
            <button id="askBtn" class="primary-btn" style="font-size:12px; padding:6px 12px;">Generate Answer</button>
          </div>
          <div id="answerOutput" class="hidden" style="margin-top:12px;"></div>
        </div>
      </details>
    </div>
  </div>

  <div id="error" class="error"></div>

  <!-- Scripts -->
  <!-- Scripts -->
  <script src="jspdf.umd.min.js"></script>
  <script type="module" src="pdf_init.js"></script>
  <script src="loader.js"></script>
</body>

</html>